<div class="crear-examen-container">
  <div class="back-button-container">
    <a routerLink="/profesor" class="btn-secondary">
      <i class="btn-icon">‚Üê</i> Volver al Dashboard
    </a>
  </div>
  <h2 class="page-title">Crear Examen</h2>

  <form #f="ngForm" (ngSubmit)="crear()" *ngIf="usuario && usuario.rol === 'PROFESOR'" class="examen-form">
    <div class="card">
      <div class="card-header">
        <h3>Informaci√≥n General</h3>
      </div>
      <div class="card-body">
        <div class="form-group">
          <label for="nombre">Nombre:</label>
          <input id="nombre" [(ngModel)]="examen.nombre" name="nombre" required placeholder="Nombre del examen" />
        </div>

        <div class="form-group">
          <label for="descripcion">Descripci√≥n:</label>
          <input id="descripcion" [(ngModel)]="examen.descripcion" name="descripcion" placeholder="Descripci√≥n breve del examen" />
        </div>

        <div class="form-group">
          <label for="idTema">Tema:</label>
          <select id="idTema" [(ngModel)]="examen.idTema" name="idTema" (change)="cargarPreguntasBanco()" required>
            <option value="" disabled selected>-- Seleccione un tema --</option>
            <option *ngFor="let t of temas" [value]="t.id">{{ t.nombre }}</option>
          </select>
        </div>

        <div class="form-row">
          <div class="form-group half-width">
            <label for="totalBanco">Total preguntas banco:</label>
            <input
              id="totalBanco"
              type="number"
              [(ngModel)]="examen.totalPreguntasBanco"
              name="totalBanco"
              min="1"
              required
              (change)="cargarPreguntasBanco()"
            />
          </div>

          <div class="form-group half-width">
            <label for="totalExamen">Total preguntas por estudiante:</label>
            <input
              id="totalExamen"
              type="number"
              [(ngModel)]="examen.totalPreguntasExamen"
              name="totalExamen"
              min="1"
              required
            />
          </div>
        </div>

        <div class="form-group">
          <label for="duracion">Duraci√≥n (minutos):</label>
          <input id="duracion" type="number" [(ngModel)]="examen.duracionMinutos" name="duracion" min="1" required />
        </div>

        <div class="form-row">
          <div class="form-group half-width">
            <label for="fechaInicio">Fecha de inicio:</label>
            <input id="fechaInicio" type="datetime-local" [(ngModel)]="examen.fechaInicio" name="fechaInicio" required />
          </div>

          <div class="form-group half-width">
            <label for="fechaFin">Fecha de fin:</label>
            <input id="fechaFin" type="datetime-local" [(ngModel)]="examen.fechaFin" name="fechaFin" required />
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3>Banco de preguntas</h3>
      </div>
      <div class="card-body">
        <p class="instructions">Selecciona hasta {{ examen.totalPreguntasExamen }} preguntas:</p>

        <div class="empty-message" *ngIf="preguntasBanco.length === 0">
          <i class="empty-icon">üìù</i>
          <p>No hay preguntas disponibles para el tema seleccionado.</p>
        </div>

        <div class="checkbox-list">
          <div class="checkbox-item" *ngFor="let p of preguntasBanco">
            <label class="checkbox-label">
              <input
                type="checkbox"
                #chk
                [checked]="preguntasSeleccionadas.includes(p.id)"
                (change)="togglePreguntaSeleccionada(p.id, chk.checked)"
                [disabled]="
                !preguntasSeleccionadas.includes(p.id) &&
                preguntasSeleccionadas.length >= examen.totalPreguntasExamen
              "
              />
              <span class="checkbox-text">{{ p.texto }}</span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3>Asignar a grupos</h3>
      </div>
      <div class="card-body">
        <p class="instructions">Selecciona uno o varios grupos a los que deseas asignar este examen:</p>

        <div class="empty-message" *ngIf="grupos.length === 0">
          <i class="empty-icon">üë•</i>
          <p>No hay grupos disponibles.</p>
        </div>

        <div class="checkbox-list">
          <div class="checkbox-item" *ngFor="let grupo of grupos">
            <label class="checkbox-label">
              <input
                type="checkbox"
                #chk
                [checked]="gruposSeleccionados.includes(grupo.id)"
                (change)="toggleGrupoSeleccionado(grupo.id, chk.checked)"
              />
              <span class="checkbox-text">{{ grupo.nombre }}</span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <div class="form-actions">
      <button
        type="submit"
        class="btn-primary"
        [disabled]="
          !f.valid || preguntasSeleccionadas.length !== examen.totalPreguntasExamen
        "
        [ngClass]="{'btn-disabled': !f.valid || preguntasSeleccionadas.length !== examen.totalPreguntasExamen}"
      >
        <i class="btn-icon">‚úì</i> Crear Examen
      </button>
    </div>
  </form>
</div>
